<% content_for :title, "Gastos - Expense Tracker" %>

<% # Navigation bar for dashboard navigation %>
<% if @from_dashboard %>
  <div class="bg-teal-50 border-b border-teal-200 px-6 py-3 mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <%= link_to dashboard_expenses_path, class: "text-teal-700 hover:text-teal-800 font-medium" do %>
          ← Volver al Dashboard
        <% end %>
        <% if @filter_description %>
          <span class="text-slate-600">|</span>
          <span class="text-slate-700"><%= @filter_description %></span>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<div class="space-y-6" data-controller="accessibility-enhanced">
  <!-- Filter Chips Display -->
  <div data-controller="filter-chips"
       data-filter-chips-base-url-value="/expenses"
       data-filter-chips-target="container"
       class="hidden bg-white rounded-xl shadow-sm border border-slate-200 p-4">
  </div>

  <!-- Header with Summary -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6"
       data-controller="filter-persistence"
       data-filter-persistence-storage-type-value="session"
       data-filter-persistence-auto-restore-value="true"
       data-filter-persistence-auto-save-value="true">
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
      <h1 class="text-2xl font-bold text-slate-900 mb-4 md:mb-0">Gastos</h1>
      <!-- Summary Stats -->
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
        <div class="bg-teal-50 rounded-lg p-3">
          <div class="text-2xl font-bold text-teal-700">₡<%= number_with_delimiter(@total_amount.to_i) %></div>
          <div class="text-sm text-slate-600">Total</div>
        </div>
        <div class="bg-emerald-50 rounded-lg p-3">
          <div class="text-2xl font-bold text-emerald-600"><%= @expense_count %></div>
          <div class="text-sm text-slate-600">Gastos</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-3 col-span-2 md:col-span-1">
          <div class="text-2xl font-bold text-amber-600"><%= @categories_summary.length %></div>
          <div class="text-sm text-slate-600">Categorías</div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <%= form_with url: expenses_path, method: :get,
                  class: "space-y-4 md:space-y-0 md:flex md:gap-4",
                  local: true,
                  data: {
                    "filter-persistence-target": "filterForm"
                  } do |form| %>
    <div class="flex-1">
      <%= form.select :category, options_from_collection_for_select(Category.all, :name, :name, params[:category]),
            { include_blank: "Todas las categorías" },
            { class: "w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" } %>
    </div>
    <div class="flex-1">
      <%= form.select :bank, options_for_select([["Todos los bancos", ""], ["BAC", "BAC"], ["Manual Entry", "Manual Entry"]], params[:bank]),
            {}, { class: "w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" } %>
    </div>
    <div class="flex gap-2">
      <%= form.date_field :start_date, value: params[:start_date], placeholder: "Fecha inicio",
            class: "rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" %>
      <%= form.date_field :end_date, value: params[:end_date], placeholder: "Fecha fin",
            class: "rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" %>
    </div>
    <div class="flex gap-2">
      <%= form.submit "Filtrar", class: "bg-teal-700 hover:bg-teal-800 text-white px-4 py-2 rounded-lg shadow-sm" %>
      <%= link_to "Limpiar", expenses_path, class: "bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg" %>
    </div>
    <% end %>
  </div>

  <!-- Category Summary (when not filtered) -->
  <% if params[:category].blank? && @categories_summary.any? %>
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-4">Resumen por Categoría</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <% @categories_summary.first(6).each do |category_name, amount| %>
      <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
        <span class="font-medium text-slate-700"><%= category_name %></span>
        <span class="font-bold text-slate-900">₡<%= number_with_delimiter(amount.to_i) %></span>
      </div>
      <% end %>
    </div>
  </div>
  <% end %>

  <!-- Expenses Table -->
  <div id="expense_list" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"
       data-controller="view-toggle batch-selection virtual-scroll"
       data-action="keydown@window->view-toggle#handleKeydown resize@window->view-toggle#handleResize"
       data-virtual-scroll-threshold-value="<%= @expenses.count %>"
       data-virtual-scroll-enabled-value="<%= @expenses.count > 500 %>"
       role="grid">
    <div class="px-6 py-4 bg-slate-50 border-b border-slate-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <h2 class="text-lg font-semibold text-slate-900">Lista de Gastos</h2>

          <!-- Selection Counter -->
          <span class="hidden text-sm font-medium text-teal-700 bg-teal-100 px-3 py-1 rounded-lg"
                data-batch-selection-target="selectionCounter">
            0 gastos seleccionados
          </span>

          <!-- View Toggle Button -->
          <button type="button"
                  data-view-toggle-target="toggleButton"
                  data-action="click->view-toggle#toggle"
                  class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors"
                  aria-label="Cambiar modo de vista"
                  title="Cambiar entre vista compacta y expandida (Ctrl+Shift+V)">

            <!-- Compact Icon -->
            <svg data-view-toggle-target="compactIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>

            <!-- Expanded Icon -->
            <svg data-view-toggle-target="expandedIcon" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16"></path>
            </svg>

            <span data-view-toggle-target="buttonText">Vista Compacta</span>
          </button>

          <!-- Batch Selection Mode Toggle -->
          <button type="button"
                  data-action="click->batch-selection#toggleSelectionMode"
                  class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors"
                  aria-label="Activar modo de selección"
                  title="Activar selección múltiple (Ctrl+Shift+A)">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
            </svg>
            <span>Selección Múltiple</span>
          </button>
        </div>

        <% if @active_period %>
          <span class="text-sm text-slate-600">
            Período: <%= { "day" => "Hoy", "week" => "Esta Semana", "month" => "Este Mes", "year" => "Este Año" }[@active_period] || @active_period.capitalize %>
          </span>
        <% elsif @date_from && @date_to %>
          <span class="text-sm text-slate-600">
            <% if @date_from == @date_to %>
              <%= @date_from.strftime("%d/%m/%Y") %>
            <% else %>
              <%= @date_from.strftime("%d/%m/%Y") %> - <%= @date_to.strftime("%d/%m/%Y") %>
            <% end %>
          </span>
        <% end %>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200" data-view-toggle-target="table">
        <thead class="bg-slate-50">
          <tr>
            <!-- Master Checkbox Column -->
            <th class="checkbox-header hidden px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">
              <input type="checkbox"
                     data-batch-selection-target="masterCheckbox"
                     data-action="change->batch-selection#toggleMasterSelection"
                     class="h-4 w-4 text-teal-600 focus:ring-teal-500 border-slate-300 rounded"
                     aria-label="Seleccionar todos los gastos visibles">
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Fecha</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Comercio</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Categoría</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Monto</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-view-toggle-target="expandedColumns">Banco</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-view-toggle-target="expandedColumns">Estado</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-view-toggle-target="expandedColumns">Acciones</th>
          </tr>
        </thead>
        <tbody id="expenses_table_body" class="bg-white divide-y divide-slate-100">
          <% @expenses.each do |expense| %>
            <%= render "expense_row", expense: expense, categories: @categories %>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="px-6 py-4 bg-slate-50 border-t border-slate-200">
      <div class="flex flex-col items-center gap-3">
        <% if @pagy && @pagy.pages > 1 %>
          <%= pagy_financial_nav(@pagy) %>
          <p class="text-sm text-slate-600">
            Mostrando <%= @pagy.from %>-<%= @pagy.to %> de <%= number_with_delimiter(@pagy.count) %> gastos
          </p>
        <% else %>
          <p class="text-sm text-slate-600">
            Mostrando <%= number_with_delimiter(@expenses.respond_to?(:size) ? @expenses.size : @expenses.length) %> gastos
          </p>
        <% end %>
      </div>
    </div>

    <!-- Batch Selection Toolbar -->
    <div class="hidden fixed bottom-0 left-0 right-0 bg-white border-t-2 border-teal-600 shadow-lg z-40 px-6 py-4"
         data-batch-selection-target="selectionToolbar">
      <div class="max-w-7xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-4">
          <!-- Selection Summary -->
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
            </svg>
            <span class="text-lg font-semibold text-slate-900">
              <span data-batch-selection-target="selectedCount">0</span>
              <span class="text-slate-600">de</span>
              <span data-batch-selection-target="totalCount">0</span>
              <span class="text-slate-600">gastos seleccionados</span>
            </span>
          </div>

          <!-- Clear Selection Button -->
          <button type="button"
                  data-batch-selection-target="clearSelectionButton"
                  data-action="click->batch-selection#clearSelection"
                  class="text-sm text-slate-600 hover:text-slate-900 underline">
            Limpiar selección
          </button>
        </div>

        <!-- Bulk Actions -->
        <div class="flex items-center gap-3">
          <button type="button"
                  data-batch-selection-target="bulkActionsButton"
                  data-action="click->batch-selection#openBulkOperations"
                  class="inline-flex items-center gap-2 px-4 py-2 bg-teal-700 text-white rounded-lg hover:bg-teal-800 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
            </svg>
            Operaciones en Lote
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<% # Include bulk operations modal %>
<%= render "bulk_operations_modal" %>

<% # Add smooth scroll if requested %>
<% if @scroll_to == "expense_list" %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const element = document.getElementById('expense_list');
    if (element) {
      element.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
</script>
<% end %>