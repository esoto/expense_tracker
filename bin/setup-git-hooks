#!/bin/bash
# Setup script to install Git hooks for the project
# Run this after cloning the repository: ./bin/setup-git-hooks

set -e

echo "ðŸ”§ Setting up Git hooks..."
echo ""

# Create pre-commit hook
cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash
# Pre-commit hook to ensure code quality and security before commits
# This hook runs RuboCop linting, Brakeman security scanning, and RSpec unit tests

set -e

echo "ðŸ” Running pre-commit checks..."
echo ""

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored output
print_status() {
  if [ $1 -eq 0 ]; then
    echo -e "${GREEN}âœ… $2${NC}"
  else
    echo -e "${RED}âŒ $2${NC}"
  fi
}

# Check if we're in a merge/rebase
if [ -f .git/MERGE_HEAD ] || [ -d .git/rebase-merge ] || [ -d .git/rebase-apply ]; then
  echo -e "${YELLOW}âš ï¸  Merge/rebase in progress, skipping pre-commit checks${NC}"
  exit 0
fi

# 1. Run RuboCop
echo "ðŸ“ Running RuboCop linter..."
if bundle exec rubocop --format simple; then
  print_status 0 "RuboCop passed"
else
  print_status 1 "RuboCop failed"
  echo ""
  echo -e "${YELLOW}ðŸ’¡ Tip: Run 'bundle exec rubocop -A' to auto-correct offenses${NC}"
  echo -e "${YELLOW}ðŸ’¡ Or use 'git commit --no-verify' to skip this check (not recommended)${NC}"
  exit 1
fi

echo ""

# 2. Run Brakeman security scanner
echo "ðŸ”’ Running Brakeman security scanner..."
if bundle exec brakeman --no-pager --quiet --no-summary; then
  print_status 0 "Brakeman security check passed"
else
  print_status 1 "Brakeman found security issues"
  echo ""
  echo -e "${YELLOW}ðŸ’¡ Tip: Review and fix security issues before committing${NC}"
  echo -e "${YELLOW}ðŸ’¡ Run 'bundle exec brakeman' for detailed report${NC}"
  echo -e "${YELLOW}ðŸ’¡ Or use 'git commit --no-verify' to skip this check (not recommended)${NC}"
  exit 1
fi

echo ""

# 3. Run RSpec unit tests only
echo "ðŸ§ª Running RSpec unit tests..."
if bundle exec rspec --tag unit --format progress; then
  print_status 0 "RSpec unit tests passed"
else
  print_status 1 "RSpec unit tests failed"
  echo ""
  echo -e "${YELLOW}ðŸ’¡ Tip: Fix failing tests before committing${NC}"
  echo -e "${YELLOW}ðŸ’¡ Or use 'git commit --no-verify' to skip this check (not recommended)${NC}"
  exit 1
fi

echo ""
echo -e "${GREEN}âœ¨ All pre-commit checks passed! Proceeding with commit...${NC}"
echo ""

exit 0
EOF

# Make hook executable
chmod +x .git/hooks/pre-commit

echo "âœ… Pre-commit hook installed successfully!"
echo ""
echo "The following checks will run before each commit:"
echo "  1. RuboCop linting"
echo "  2. Brakeman security scanner"
echo "  3. RSpec unit tests only (tagged with :unit)"
echo ""
echo "To bypass these checks (not recommended), use: git commit --no-verify"
