<%= form_with model: [:admin, @pattern], local: true do |f| %>
  <% if @pattern.errors.any? %>
    <div class="mb-6 bg-rose-50 border border-rose-200 text-rose-700 px-4 py-3 rounded-lg">
      <h3 class="font-semibold mb-2">Please fix the following errors:</h3>
      <ul class="list-disc list-inside">
        <% @pattern.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="space-y-6">
    <!-- Pattern Type -->
    <div>
      <%= f.label :pattern_type, class: "block text-sm font-medium text-slate-700 mb-2" %>
      <%= f.select :pattern_type,
          options_for_select(pattern_type_options, @pattern.pattern_type),
          { prompt: 'Select pattern type...' },
          class: "w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500",
          data: {
            controller: "pattern-form",
            action: "change->pattern-form#updateValueHelp"
          } %>
      <p class="mt-1 text-sm text-slate-500">Choose how this pattern will match expenses</p>
    </div>

    <!-- Pattern Value -->
    <div>
      <%= f.label :pattern_value, class: "block text-sm font-medium text-slate-700 mb-2" %>
      <%= f.text_field :pattern_value,
          class: "w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500",
          placeholder: "Enter pattern value...",
          data: { "pattern-form-target": "valueField" } %>
      <div data-pattern-form-target="valueHelp" class="mt-1 text-sm text-slate-500">
        <% case @pattern.pattern_type %>
        <% when 'merchant' %>
          Enter the merchant name to match (case-insensitive)
        <% when 'keyword' %>
          Enter a keyword to search for in descriptions and merchant names
        <% when 'description' %>
          Enter text to match in expense descriptions
        <% when 'amount_range' %>
          Enter range as: min-max (e.g., 10.00-50.00)
        <% when 'regex' %>
          Enter a regular expression pattern
        <% when 'time' %>
          Enter: morning, afternoon, evening, night, weekend, weekday, or time range (09:00-17:00)
        <% else %>
          Select a pattern type to see value format help
        <% end %>
      </div>
    </div>

    <!-- Category -->
    <div>
      <%= f.label :category_id, "Category", class: "block text-sm font-medium text-slate-700 mb-2" %>
      <%= f.select :category_id,
          options_for_select(@categories.map { |c| [c.name, c.id] }, @pattern.category_id),
          { prompt: 'Select category...' },
          class: "w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500" %>
      <p class="mt-1 text-sm text-slate-500">The category to assign when this pattern matches</p>
    </div>

    <!-- Confidence Weight -->
    <div>
      <%= f.label :confidence_weight, class: "block text-sm font-medium text-slate-700 mb-2" %>
      <div class="flex items-center space-x-4">
        <%= f.range_field :confidence_weight,
            min: CategorizationPattern::MIN_CONFIDENCE_WEIGHT,
            max: CategorizationPattern::MAX_CONFIDENCE_WEIGHT,
            step: 0.1,
            class: "flex-1",
            data: {
              controller: "range-display",
              "range-display-target": "slider",
              action: "input->range-display#updateValue"
            } %>
        <span data-range-display-target="value" class="text-lg font-semibold text-slate-900 w-12 text-center">
          <%= @pattern.confidence_weight.round(1) %>
        </span>
      </div>
      <p class="mt-1 text-sm text-slate-500">Higher weight = higher priority when multiple patterns match</p>
    </div>

    <!-- Active Status -->
    <div class="flex items-center">
      <%= f.check_box :active, class: "h-4 w-4 text-teal-600 focus:ring-teal-500 border-slate-300 rounded" %>
      <%= f.label :active, "Active", class: "ml-2 block text-sm text-slate-900" %>
      <p class="ml-2 text-sm text-slate-500">Inactive patterns won't be used for categorization</p>
    </div>

    <!-- Test Pattern Section -->
    <div class="border-t pt-6">
      <h3 class="text-lg font-semibold text-slate-900 mb-4">Test Pattern</h3>
      <div class="bg-slate-50 rounded-lg p-4">
        <div class="mb-3">
          <input type="text"
                 placeholder="Enter test text..."
                 data-pattern-form-target="testInput"
                 class="w-full px-3 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
        </div>
        <button type="button"
                data-action="click->pattern-form#testPattern"
                class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg text-sm font-medium">
          Test Match
        </button>
        <div data-pattern-form-target="testResult" class="mt-3"></div>
      </div>
    </div>
  </div>

  <!-- Form Actions -->
  <div class="mt-8 flex justify-between">
    <%= link_to "Cancel", admin_patterns_path,
        class: "px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg text-sm font-medium" %>
    <div class="space-x-3">
      <button type="submit"
              name="commit"
              value="save_and_continue"
              class="px-4 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg text-sm font-medium">
        Save and Continue Editing
      </button>
      <%= f.submit @pattern.new_record? ? "Create Pattern" : "Update Pattern",
          class: "px-4 py-2 bg-teal-700 hover:bg-teal-800 text-white rounded-lg text-sm font-medium" %>
    </div>
  </div>
<% end %>