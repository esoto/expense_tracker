<%# Category with Confidence Display Partial %>
<%# This partial displays the category with ML confidence indicators and correction interface %>

<turbo-frame id="expense_<%= expense.id %>_category" class="inline-block">
  <div class="relative inline-flex items-center gap-2" 
       data-controller="category-confidence"
       data-category-confidence-expense-id-value="<%= expense.id %>"
       data-category-confidence-level-value="<%= expense.confidence_level %>"
       data-category-confidence-percentage-value="<%= expense.confidence_percentage %>"
       data-category-confidence-explanation-value="<%= expense.ml_confidence_explanation || '' %>">
    
    <%# Category Badge %>
    <% if expense.category %>
      <span class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full transition-all"
            style="background-color: <%= expense.category.color %>20; color: <%= expense.category.color %>;">
        <%= expense.category.name %>
      </span>
    <% else %>
      <span class="inline-flex items-center px-2.5 py-1 text-xs font-medium rounded-full bg-slate-100 text-slate-600">
        Sin categor√≠a
      </span>
    <% end %>
    
    <%# Confidence Indicator %>
    <% if expense.ml_confidence.present? %>
      <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium border cursor-help <%= confidence_color_class(expense.confidence_level) %>"
            data-category-confidence-target="badge"
            tabindex="0"
            role="button"
            aria-label="Confianza: <%= expense.confidence_percentage %>%">
        
        <%# Confidence Icon %>
        <% case expense.confidence_level %>
        <% when :high %>
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        <% when :medium %>
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        <% when :low, :very_low %>
          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
          </svg>
        <% end %>
        
        <%= expense.confidence_percentage %>%
      </span>
      
      <%# Quick Correction Button for Low Confidence %>
      <% if expense.needs_review? %>
        <button class="inline-flex items-center justify-center w-6 h-6 rounded-full hover:bg-amber-50 transition-colors"
                data-action="click->category-confidence#showCorrection"
                data-category-confidence-target="correctionTrigger"
                title="Corregir categor√≠a (Presiona 'C')"
                aria-label="Corregir categor√≠a">
          <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
          </svg>
        </button>
      <% end %>
    <% end %>
    
    <%# Learning Indicator %>
    <% if expense.ml_last_corrected_at.present? && expense.ml_last_corrected_at > 1.hour.ago %>
      <span class="inline-flex items-center justify-center w-5 h-5 text-xs animate-pulse"
            title="Sistema aprendiendo de esta correcci√≥n">
        üß†
      </span>
    <% end %>
    
    <%# Suggested Category Display (if different from current) %>
    <% if expense.ml_suggested_category_id.present? && expense.ml_suggested_category_id != expense.category_id %>
      <div class="absolute top-full mt-1 left-0 z-30 p-2 bg-amber-50 border border-amber-200 rounded-lg shadow-lg whitespace-nowrap">
        <div class="flex items-center gap-2">
          <span class="text-xs text-amber-800 font-medium">Sugerencia:</span>
          <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full"
                style="background-color: <%= expense.ml_suggested_category.color %>20; color: <%= expense.ml_suggested_category.color %>;">
            <%= expense.ml_suggested_category.name %>
          </span>
          <div class="flex gap-1 ml-2">
            <%= button_to accept_suggestion_expense_path(expense),
                          method: :post,
                          class: "inline-flex items-center justify-center w-6 h-6 bg-emerald-600 text-white rounded hover:bg-emerald-700",
                          title: "Aceptar sugerencia",
                          data: { turbo_frame: "expense_#{expense.id}_category" } do %>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
              </svg>
            <% end %>
            <%= button_to reject_suggestion_expense_path(expense),
                          method: :post,
                          class: "inline-flex items-center justify-center w-6 h-6 bg-rose-600 text-white rounded hover:bg-rose-700",
                          title: "Rechazar sugerencia",
                          data: { 
                            turbo_frame: "expense_#{expense.id}_category",
                            action: "click->category-confidence#showCorrection"
                          } do %>
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</turbo-frame>

<%# Mobile-Optimized Display %>
<% if defined?(mobile) && mobile %>
  <div class="mt-2 pt-2 border-t border-slate-100">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-xs text-slate-500">Categor√≠a:</span>
        <% if expense.category %>
          <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full"
                style="background-color: <%= expense.category.color %>20; color: <%= expense.category.color %>;">
            <%= expense.category.name %>
          </span>
        <% else %>
          <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-slate-100 text-slate-600">
            Sin categor√≠a
          </span>
        <% end %>
      </div>
      
      <% if expense.ml_confidence.present? %>
        <div class="flex items-center gap-1">
          <% case expense.confidence_level %>
          <% when :high %>
            <svg class="w-4 h-4 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          <% when :medium %>
            <svg class="w-4 h-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          <% when :low, :very_low %>
            <svg class="w-4 h-4 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
          <% end %>
          <span class="text-xs font-medium <%= confidence_text_color(expense.confidence_level) %>">
            <%= expense.confidence_percentage %>%
          </span>
        </div>
      <% end %>
    </div>
    
    <% if expense.needs_review? %>
      <button class="mt-2 w-full px-3 py-1.5 bg-amber-100 text-amber-800 text-xs font-medium rounded-lg hover:bg-amber-200 transition-colors"
              data-controller="category-confidence"
              data-category-confidence-expense-id-value="<%= expense.id %>"
              data-action="click->category-confidence#showCorrection">
        Revisar categor√≠a
      </button>
    <% end %>
  </div>
<% end %>