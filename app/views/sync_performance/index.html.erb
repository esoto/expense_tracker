<div class="min-h-screen bg-slate-50 py-8">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 class="text-3xl font-bold text-slate-900">Panel de Rendimiento de Sincronización</h1>
          <p class="mt-2 text-slate-600">Monitoreo y análisis del rendimiento del sistema</p>
        </div>
        <div class="mt-4 sm:mt-0 flex items-center space-x-4">
          <!-- Period selector -->
          <div class="relative" data-controller="dropdown">
            <button type="button" 
                    class="inline-flex items-center px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-teal-500"
                    data-dropdown-target="button"
                    data-action="click->dropdown#toggle">
              <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <%= period_label(@period) %>
            </button>
            <div class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-slate-200 z-10" 
                 data-dropdown-target="menu">
              <%= link_to "Última hora", sync_performance_path(period: "last_hour"), 
                          class: "block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50" %>
              <%= link_to "Últimas 24 horas", sync_performance_path(period: "last_24_hours"), 
                          class: "block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50" %>
              <%= link_to "Últimos 7 días", sync_performance_path(period: "last_7_days"), 
                          class: "block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50" %>
              <%= link_to "Últimos 30 días", sync_performance_path(period: "last_30_days"), 
                          class: "block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50" %>
            </div>
          </div>
          
          <!-- Export button -->
          <%= link_to sync_performance_export_path(period: @period, format: :csv), 
                      class: "inline-flex items-center px-4 py-2 bg-teal-700 text-white rounded-lg hover:bg-teal-800 focus:outline-none focus:ring-2 focus:ring-teal-500" do %>
            <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Exportar CSV
          <% end %>
        </div>
      </div>
    </div>

    <!-- Key Metrics Summary -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <!-- Total Syncs -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-slate-600">Sincronizaciones Totales</p>
            <p class="mt-2 text-3xl font-bold text-slate-900"><%= number_with_delimiter(@metrics_summary[:total_syncs]) %></p>
          </div>
          <div class="p-3 bg-teal-100 rounded-lg">
            <svg class="h-6 w-6 text-teal-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Success Rate -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-slate-600">Tasa de Éxito</p>
            <p class="mt-2 text-3xl font-bold <%= success_rate_color(@metrics_summary[:success_rate]) %>">
              <%= @metrics_summary[:success_rate] %>%
            </p>
          </div>
          <div class="p-3 <%= success_rate_bg(@metrics_summary[:success_rate]) %> rounded-lg">
            <svg class="h-6 w-6 <%= success_rate_icon_color(@metrics_summary[:success_rate]) %>" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Average Duration -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-slate-600">Duración Promedio</p>
            <p class="mt-2 text-3xl font-bold text-slate-900"><%= @metrics_summary[:average_duration] %></p>
          </div>
          <div class="p-3 bg-amber-100 rounded-lg">
            <svg class="h-6 w-6 text-amber-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
        </div>
      </div>

      <!-- Processing Rate -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-slate-600">Velocidad de Procesamiento</p>
            <p class="mt-2 text-3xl font-bold text-slate-900"><%= @metrics_summary[:processing_rate] %></p>
            <p class="text-sm text-slate-500">correos/seg</p>
          </div>
          <div class="p-3 bg-slate-100 rounded-lg">
            <svg class="h-6 w-6 text-slate-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
          </div>
        </div>
      </div>
    </div>

    <!-- Performance Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Success Rate Trend -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">Tendencia de Tasa de Éxito</h3>
        <div class="h-64" data-controller="chart" 
             data-chart-type-value="line"
             data-chart-data-value="<%= @performance_data[:success_rate_trend].to_json %>">
          <canvas data-chart-target="canvas"></canvas>
        </div>
      </div>

      <!-- Duration Trend -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">Tendencia de Duración</h3>
        <div class="h-64" data-controller="chart" 
             data-chart-type-value="line"
             data-chart-data-value="<%= @performance_data[:duration_trend].to_json %>">
          <canvas data-chart-target="canvas"></canvas>
        </div>
      </div>
    </div>

    <!-- Account Performance Table -->
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-8">
      <h3 class="text-lg font-semibold text-slate-900 mb-4">Rendimiento por Cuenta</h3>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-slate-200">
          <thead>
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Banco</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Correo</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Sincronizaciones</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Tasa de Éxito</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Duración Promedio</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Correos Procesados</th>
              <th class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Errores</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            <% if @account_metrics.present? && @account_metrics.any? %>
              <% @account_metrics.each do |account| %>
                <tr class="hover:bg-slate-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">
                    <%= account[:bank_name] %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                    <%= account[:email] %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-slate-900">
                    <%= account[:total_syncs] %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full <%= success_rate_badge(account[:success_rate]) %>">
                      <%= account[:success_rate] %>%
                    </span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-slate-900">
                    <%= account[:average_duration] %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-slate-900">
                    <%= number_with_delimiter(account[:emails_processed]) %>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-center">
                    <% if account[:errors] > 0 %>
                      <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-rose-100 text-rose-700">
                        <%= account[:errors] %>
                      </span>
                    <% else %>
                      <span class="text-slate-400">-</span>
                    <% end %>
                  </td>
                </tr>
              <% end %>
            <% else %>
              <tr>
                <td colspan="7" class="px-6 py-8 text-center text-slate-500">
                  No hay datos de rendimiento disponibles para el período seleccionado
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Error Analysis and Peak Times -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Error Analysis -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">Análisis de Errores</h3>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-600">Total de Errores</span>
            <span class="text-sm font-semibold text-rose-600"><%= @error_analysis[:total_errors] %></span>
          </div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-600">Tasa de Error</span>
            <span class="text-sm font-semibold text-rose-600"><%= @error_analysis[:error_rate] %>%</span>
          </div>
          
          <div class="pt-4 border-t border-slate-200">
            <h4 class="text-sm font-medium text-slate-700 mb-2">Tipos de Error</h4>
            <% if @error_analysis[:error_types].present? && @error_analysis[:error_types].any? %>
              <% @error_analysis[:error_types].first(5).each do |error_type, count| %>
                <div class="flex items-center justify-between py-1">
                  <span class="text-sm text-slate-600 truncate"><%= error_type || "Sin especificar" %></span>
                  <span class="text-sm font-medium text-slate-900"><%= count %></span>
                </div>
              <% end %>
            <% else %>
              <p class="text-sm text-slate-500">Sin errores registrados</p>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Peak Times -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">Horas Pico</h3>
        <div class="space-y-3">
          <% if @peak_times[:peak_hours].present? && @peak_times[:peak_hours].any? %>
            <% @peak_times[:peak_hours].each_with_index do |peak, index| %>
              <div class="flex items-center justify-between">
                <div class="flex items-center">
                  <span class="flex-shrink-0 w-8 h-8 flex items-center justify-center rounded-full bg-teal-100 text-teal-700 text-xs font-semibold">
                    <%= index + 1 %>
                  </span>
                  <span class="ml-3 text-sm text-slate-700"><%= peak[:hour] %></span>
                </div>
                <div class="flex items-center">
                  <div class="w-24 bg-slate-200 rounded-full h-2 mr-3">
                    <div class="bg-teal-700 h-2 rounded-full" style="width: <%= (peak[:count].to_f / @peak_times[:peak_hours].first[:count] * 100).round %>%"></div>
                  </div>
                  <span class="text-sm font-medium text-slate-900"><%= peak[:count] %></span>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="text-sm text-slate-500 text-center py-4">No hay datos de horas pico disponibles</p>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Real-time updates via Turbo Streams -->
<%= turbo_stream_from "sync_performance_updates" %>