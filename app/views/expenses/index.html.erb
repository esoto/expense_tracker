<% content_for :title, "Gastos - Expense Tracker" %>

<% # Navigation bar for dashboard navigation %>
<% if @from_dashboard %>
  <div class="bg-teal-50 border-b border-teal-200 px-6 py-3 mb-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center space-x-2">
        <%= link_to dashboard_expenses_path, class: "text-teal-700 hover:text-teal-800 font-medium" do %>
          ← Volver al Dashboard
        <% end %>
        <% if @filter_description %>
          <span class="text-slate-600">|</span>
          <span class="text-slate-700"><%= @filter_description %></span>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<div class="space-y-6">
  <!-- Header with Summary -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-4">
      <h1 class="text-2xl font-bold text-slate-900 mb-4 md:mb-0">Gastos</h1>
      <!-- Summary Stats -->
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">
        <div class="bg-teal-50 rounded-lg p-3">
          <div class="text-2xl font-bold text-teal-700">₡<%= number_with_delimiter(@total_amount.to_i) %></div>
          <div class="text-sm text-slate-600">Total</div>
        </div>
        <div class="bg-emerald-50 rounded-lg p-3">
          <div class="text-2xl font-bold text-emerald-600"><%= @expense_count %></div>
          <div class="text-sm text-slate-600">Gastos</div>
        </div>
        <div class="bg-amber-50 rounded-lg p-3 col-span-2 md:col-span-1">
          <div class="text-2xl font-bold text-amber-600"><%= @categories_summary.length %></div>
          <div class="text-sm text-slate-600">Categorías</div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <%= form_with url: expenses_path, method: :get, class: "space-y-4 md:space-y-0 md:flex md:gap-4", local: true do |form| %>
    <div class="flex-1">
      <%= form.select :category, options_from_collection_for_select(Category.all, :name, :name, params[:category]),
            { include_blank: "Todas las categorías" },
            { class: "w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" } %>
    </div>
    <div class="flex-1">
      <%= form.select :bank, options_for_select([["Todos los bancos", ""], ["BAC", "BAC"], ["Manual Entry", "Manual Entry"]], params[:bank]),
            {}, { class: "w-full rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" } %>
    </div>
    <div class="flex gap-2">
      <%= form.date_field :start_date, value: params[:start_date], placeholder: "Fecha inicio",
            class: "rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" %>
      <%= form.date_field :end_date, value: params[:end_date], placeholder: "Fecha fin",
            class: "rounded-md border-slate-300 shadow-sm focus:border-teal-500 focus:ring-teal-500" %>
    </div>
    <div class="flex gap-2">
      <%= form.submit "Filtrar", class: "bg-teal-700 hover:bg-teal-800 text-white px-4 py-2 rounded-lg shadow-sm" %>
      <%= link_to "Limpiar", expenses_path, class: "bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg" %>
    </div>
    <% end %>
  </div>

  <!-- Category Summary (when not filtered) -->
  <% if params[:category].blank? && @categories_summary.any? %>
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-4">Resumen por Categoría</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <% @categories_summary.first(6).each do |category_name, amount| %>
      <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
        <span class="font-medium text-slate-700"><%= category_name %></span>
        <span class="font-bold text-slate-900">₡<%= number_with_delimiter(amount.to_i) %></span>
      </div>
      <% end %>
    </div>
  </div>
  <% end %>

  <!-- Expenses Table -->
  <div id="expense_list" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden"
       data-controller="view-toggle"
       data-action="keydown@window->view-toggle#handleKeydown resize@window->view-toggle#handleResize">
    <div class="px-6 py-4 bg-slate-50 border-b border-slate-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <h2 class="text-lg font-semibold text-slate-900">Lista de Gastos</h2>
          
          <!-- View Toggle Button -->
          <button type="button"
                  data-view-toggle-target="toggleButton"
                  data-action="click->view-toggle#toggle"
                  class="inline-flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-lg bg-slate-100 text-slate-700 hover:bg-slate-200 transition-colors"
                  aria-label="Cambiar modo de vista"
                  title="Cambiar entre vista compacta y expandida (Ctrl+Shift+V)">
            
            <!-- Compact Icon -->
            <svg data-view-toggle-target="compactIcon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
            
            <!-- Expanded Icon -->
            <svg data-view-toggle-target="expandedIcon" class="w-4 h-4 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16"></path>
            </svg>
            
            <span data-view-toggle-target="buttonText">Vista Compacta</span>
          </button>
        </div>
        
        <% if @active_period %>
          <span class="text-sm text-slate-600">
            Período: <%= { "day" => "Hoy", "week" => "Esta Semana", "month" => "Este Mes", "year" => "Este Año" }[@active_period] || @active_period.capitalize %>
          </span>
        <% elsif @date_from && @date_to %>
          <span class="text-sm text-slate-600">
            <% if @date_from == @date_to %>
              <%= @date_from.strftime("%d/%m/%Y") %>
            <% else %>
              <%= @date_from.strftime("%d/%m/%Y") %> - <%= @date_to.strftime("%d/%m/%Y") %>
            <% end %>
          </span>
        <% end %>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200" data-view-toggle-target="table">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Fecha</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Comercio</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Categoría</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Monto</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-view-toggle-target="expandedColumns">Banco</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-view-toggle-target="expandedColumns">Estado</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" data-view-toggle-target="expandedColumns">Acciones</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-slate-100">
          <% @expenses.each do |expense| %>
          <tr class="hover:bg-slate-50 transition-all duration-200">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">
              <%= expense.transaction_date.strftime("%d/%m/%Y") %>
            </td>
            <td class="px-6 py-4 text-sm text-slate-900">
              <div class="font-medium">
                <% if expense.merchant_name? %>
                <%= expense.merchant_name %>
                <% else %>
                <span class="text-rose-600 italic">⚠️ Sin comercio (verificar)</span>
                <% end %>
              </div>
              <% if expense.description? && expense.description != expense.merchant_name %>
              <div class="text-slate-500 text-xs expense-description"><%= expense.description %></div>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
              <div class="expense-category-cell">
                <%= render "category_with_confidence", expense: expense %>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-slate-900">
              <%= currency_symbol(expense) %><%= number_with_delimiter(expense.amount.to_i) %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900" data-view-toggle-target="expandedColumns">
              <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full
                           <%= expense.bank_name == 'BAC' ? 'bg-rose-100 text-rose-700' : 'bg-slate-100 text-slate-700' %>">
                <%= expense.bank_name %>
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm" data-view-toggle-target="expandedColumns">
              <% case expense.status %>
              <% when 'processed' %>
              <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-emerald-100 text-emerald-800">
                Procesado
              </span>
              <% when 'pending' %>
              <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-amber-100 text-amber-800">
                Pendiente
              </span>
              <% when 'duplicate' %>
              <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-rose-100 text-rose-800">
                Duplicado
              </span>
              <% end %>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2" data-view-toggle-target="expandedColumns">
              <%= link_to "Ver", expense, class: "text-teal-600 hover:text-teal-800" %>
              <%= link_to "Editar", edit_expense_path(expense), class: "text-slate-600 hover:text-slate-800" %>
              <%= button_to "Eliminar", expense, method: :delete,
                    data: { turbo_confirm: "¿Estás seguro?" },
                    class: "text-rose-600 hover:text-rose-800 inline" %>
            </td>
          </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 text-center text-slate-600">
      Mostrando los <%= @expenses.count %> gastos más recientes
    </div>
  </div>
</div>

<% # Add smooth scroll if requested %>
<% if @scroll_to == "expense_list" %>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const element = document.getElementById('expense_list');
    if (element) {
      element.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  });
</script>
<% end %>