<% content_for :title, "#{@expense.merchant_name? ? @expense.merchant_name : 'Sin comercio'} - Expense Tracker" %>

<div class="max-w-3xl mx-auto space-y-6">
  <!-- Header -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-2xl font-bold text-slate-900">Detalle del Gasto</h1>
      <div class="flex space-x-3">
        <%= link_to "Editar", edit_expense_path(@expense),
            class: "bg-teal-700 hover:bg-teal-800 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm" %>
        <%= button_to "Eliminar", @expense, method: :delete,
            data: { turbo_confirm: "¿Estás seguro de que quieres eliminar este gasto?" },
            class: "bg-rose-600 hover:bg-rose-700 text-white px-4 py-2 rounded-lg text-sm font-medium shadow-sm" %>
        <%= link_to "Volver", expenses_path,
            class: "bg-slate-200 hover:bg-slate-300 text-slate-700 px-4 py-2 rounded-lg text-sm font-medium" %>
      </div>
    </div>

    <!-- Amount Display -->
    <div class="text-center py-6 bg-slate-50 rounded-lg mb-6">
      <div class="text-4xl font-bold text-slate-900 mb-2">₡<%= number_with_delimiter(@expense.amount.to_i) %></div>
      <div class="text-lg text-slate-600">
        <% if @expense.merchant_name? %>
        <%= @expense.merchant_name %>
        <% else %>
        <span class="text-rose-600 italic">⚠️ Sin comercio (error de procesamiento)</span>
        <% end %>
      </div>
    </div>

    <!-- Status Badge -->
    <div class="flex justify-center mb-4">
      <% case @expense.status %>
      <% when 'processed' %>
      <span class="inline-flex px-4 py-2 text-sm font-medium rounded-full bg-emerald-100 text-emerald-800">
        ✓ Procesado
      </span>
      <% when 'pending' %>
      <span class="inline-flex px-4 py-2 text-sm font-medium rounded-full bg-amber-100 text-amber-800">
        ⏳ Pendiente
      </span>
      <% when 'duplicate' %>
      <span class="inline-flex px-4 py-2 text-sm font-medium rounded-full bg-rose-100 text-rose-800">
        ⚠️ Duplicado
      </span>
      <% end %>
    </div>
  </div>

  <!-- Expense Details -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-4">Información del Gasto</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Basic Info -->
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Fecha de Transacción</label>
          <div class="flex items-center text-slate-900">
            <svg class="w-4 h-4 mr-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <%= @expense.transaction_date.strftime("%A, %d de %B de %Y") %>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Comercio</label>
          <div class="flex items-center text-slate-900">
            <svg class="w-4 h-4 mr-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
            <% if @expense.merchant_name? %>
              <%= @expense.merchant_name %>
            <% else %>
              <span class="text-rose-600 italic">⚠️ Sin comercio (error de procesamiento)</span>
            <% end %>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Descripción</label>
          <div class="flex items-center text-slate-900">
            <svg class="w-4 h-4 mr-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <%= @expense.description? ? @expense.description : "Sin descripción" %>
          </div>
        </div>
      </div>

      <!-- Category & Bank Info -->
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Categoría</label>
          <div class="flex items-center">
            <% if @expense.category %>
            <div class="w-4 h-4 rounded mr-2" style="background-color: <%= @expense.category.color %>;"></div>
            <span class="text-slate-900"><%= @expense.category.name %></span>
            <% else %>
            <span class="text-slate-500">Sin categoría asignada</span>
            <% end %>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Banco</label>
          <div class="flex items-center text-slate-900">
            <svg class="w-4 h-4 mr-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v11H4V10z"></path>
            </svg>
            <%= @expense.bank_name %>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Cuenta de Email</label>
          <div class="flex items-center text-slate-900">
            <svg class="w-4 h-4 mr-2 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
            </svg>
            <%= @expense.email_account&.email || "Entrada manual" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Metadata -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
    <h2 class="text-lg font-semibold text-slate-900 mb-4">Metadatos</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
      <div>
        <label class="block font-medium text-slate-700 mb-1">Creado</label>
        <p class="text-slate-600">
          <%= @expense.created_at.strftime("%d/%m/%Y a las %H:%M") %>
          (<%= time_ago_in_words(@expense.created_at) %> ago)
        </p>
      </div>

      <div>
        <label class="block font-medium text-slate-700 mb-1">Última actualización</label>
        <p class="text-slate-600">
          <%= @expense.updated_at.strftime("%d/%m/%Y a las %H:%M") %>
          (<%= time_ago_in_words(@expense.updated_at) %> ago)
        </p>
      </div>

      <div>
        <label class="block font-medium text-slate-700 mb-1">ID</label>
        <p class="text-slate-600 font-mono">#<%= @expense.id %></p>
      </div>

      <% if @expense.parsed_data? %>
      <div>
        <label class="block font-medium text-slate-700 mb-1">Datos parseados</label>
        <p class="text-slate-600">Disponible</p>
      </div>
      <% end %>
    </div>

    <!-- Raw Email Content (if available) -->
    <% if @expense.raw_email_content? %>
    <div class="mt-6 pt-6 border-t border-slate-200">
      <label class="block font-medium text-slate-700 mb-2">Contenido del Email Original</label>
      <details class="mt-2">
        <summary class="cursor-pointer text-teal-600 hover:text-teal-800 text-sm">Mostrar contenido del email</summary>
        <div class="mt-3 bg-slate-100 rounded-lg p-4 max-h-64 overflow-y-auto">
          <pre class="text-xs text-slate-700 whitespace-pre-wrap"><%= @expense.raw_email_content %></pre>
        </div>
      </details>
    </div>
    <% end %>
  </div>
</div>