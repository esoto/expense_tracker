#!/usr/bin/env ruby
# Fast unit tests for development workflow
# Only runs tests tagged as :unit or by default (models, controllers, services without integration tags)

require 'fileutils'

# Ensure we're in the Rails root
Dir.chdir(File.expand_path('..', __dir__))

# Set test environment and tier for coverage
ENV['RAILS_ENV'] = 'test'
ENV['TEST_TIER'] = 'unit'

# Build RSpec command with properly quoted arguments
# --tag unit: include tests auto-tagged from standard Rails dirs (models, services, controllers, etc.)
# --tag ~slow: exclude slow tests (system, performance)
cmd = if ENV['CI']
  "bundle exec rspec --tag unit --tag ~slow --format progress --fail-fast=10 --order random"
else
  "bundle exec rspec --tag unit --tag ~slow --format progress --profile=5 --fail-fast=5 --order random"
end

puts "ðŸ§ª Running unit tests (should complete in <30 seconds)..."
puts "Command: #{cmd}"
puts

# In CI, add some debugging info
if ENV['CI']
  puts "CI Environment detected"
  puts "Ruby version: #{RUBY_VERSION}"
  puts "Bundler version: #{Bundler::VERSION}" if defined?(Bundler::VERSION)
  puts "Current directory: #{Dir.pwd}"
  
  # Check if test files exist
  unit_tests = Dir['spec/**/*_spec.rb'].select do |file|
    content = File.read(file)
    content.include?('unit: true')
  end
  puts "Found #{unit_tests.size} unit-tagged test files"
end

# Execute with proper exit code
system(cmd)
exit_code = $?.exitstatus || 1

if exit_code == 0
  puts
  puts "âœ… All unit tests passed!"
else
  puts
  puts "âŒ Some unit tests failed (exit code: #{exit_code})"
end

exit exit_code